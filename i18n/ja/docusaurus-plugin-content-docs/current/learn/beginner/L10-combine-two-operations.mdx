---
sidebar_position: 10
title: "2操作を合成"
description: "複数操作を1つのトランザクションにまとめる"
---

import BrowserOnly from '@docusaurus/BrowserOnly';
import { PtbBuilderDemo } from '@site/src/components/PtbBuilderDemo';

# 2操作を合成

このレッスンでは、PTB Builderを使って**2つの送金操作を1つのトランザクションにまとめる**方法を学びます。**難しくありません**。サイト内のビジュアルエディタで、すぐに試すことができます。

## PTB（Programmable Transaction Block）とは

Suiでは、複数の操作を**1つのトランザクション**にまとめて実行できます。これを **PTB（Programmable Transaction Block）** と呼びます。

PTBを使うと、以下のようなメリットがあります：

- **ガス代の節約（主にオーバーヘッド）** — 複数トランザクションに分けるより、署名や基本コストを1回にまとめられます
- **原子性（アトミック性）** — すべての操作が成功するか、すべて失敗するかのどちらかになります（中途半端な状態になりません）
- **効率的** — 1回の署名で複数の操作を完了できます

:::tip PTBのイメージ
「Aさんに1 SUI送金」と「Bさんに2 SUI送金」を別々に実行すると、2回署名が必要で、ガス代も2回かかります。
PTBでまとめると、1回の署名・1回のガス代で済みます。
:::

:::tip ガス代についての注意
PTBにすると、操作そのものの計算量は合算されます。
ただし、トランザクションの基本コストや署名は1回分で済みます。
:::

---

## 前提条件

このレッスンを始める前に、以下が完了していることを確認してください：

- [Slushウォレットをインストール](/docs/getting-started/L01-install-slush) 済み
- [Devnetに切り替え](/docs/getting-started/L02-switch-devnet) 済み
- [Faucetでテストトークンを取得](/docs/getting-started/L06-get-test-tokens) 済み

---

## PTB Builder で2つの送金を作成

以下のビジュアルエディタで、2つの送金操作を1つのトランザクションにまとめる方法を学びましょう。
すでに2つの送金操作が設定済みのテンプレートがロードされています。

<BrowserOnly>
  {() => <PtbBuilderDemo templateId="double-transfer" />}
</BrowserOnly>

### 使い方

1. **ウォレットを接続**: 右上のウォレットアイコンからSlushウォレットを接続します
2. **フローを確認**: すでに2つの送金操作（SplitCoins → TransferObjects × 2）が設定されています
   ```
   Start → SplitCoins(1) → TransferObjects(1) → SplitCoins(2) → TransferObjects(2) → End
   ```
3. **金額を変更** (オプション):
   - 下部にある `number` ノードをクリックすると、送金額を変更できます
   - デフォルト: 1つ目は 1 SUI (1000000000 mist)、2つ目は 2 SUI (2000000000 mist)
4. **送金先を変更** (オプション):
   - デフォルトでは自分のウォレット（`my wallet`）に送金されます
   - 別のアドレスに送りたい場合は、`TransferObjects` ノードをクリックして編集できます
   - 送金先の例:
     - 自分のアドレスを2回使う（自分自身に送金）
     - Slushで新しいアカウントを作成して、そのアドレスを使用
     - [L05で作成したCLIアドレス](/docs/getting-started/L05-connect-cli-to-devnet)を使用
5. **実行**: 右上の「**Execute**」ボタンをクリックして実行します
6. **結果を確認**: トランザクションダイジェストが表示されたら、「**Explorer**」リンクで詳細を確認できます

:::tip 重要なポイント
同じ `gas` コインを2回使用している点に注目してください。
PTBでは、1つのgasコインから複数回分割（SplitCoins）して、それぞれ別のアドレスに送金できます。
:::

:::tip 自分のアドレスに送った場合
自分自身に送金すると、Explorer 上では残高がほぼ変わらず、
トランザクション内容だけが確認できます。
挙動確認としては問題ありません。
:::

---

## Explorerで確認

トランザクション実行後、Explorerで結果を確認しましょう：

1. 表示された Transaction Digest の横の「**Explorer**」リンクをクリックします
2. Suiscan（または別のExplorer）が開きます
3. **Transactions** セクションで、2つの TransferObjects 操作が含まれていることを確認します

---

## 成功の確認

以下ができれば、このレッスンは完了です：

- [ ] PTB Builderで2つの送金操作を確認できた
- [ ] 必要に応じて金額や送金先を変更できた
- [ ] 1つのトランザクションとして実行できた
- [ ] Explorerで2つの送金操作が含まれていることを確認できた
- [ ] gasコインが2回使用されていることを理解できた

---

## よくあるトラブル

### ウォレットが接続できない

- ブラウザ拡張機能のSlushウォレットがインストールされているか確認してください
- ネットワークがDevnetに設定されているか確認してください
- [L07: ウォレットをPTB Builderに接続する](/docs/learn/beginner/L07-connect-wallet-to-ptb-builder) を参照してください

### Execute ボタンが押せない

- ウォレットが接続されているか確認してください
- すべてのノードが正しく接続されているか確認してください
- Start から End まで途切れなくフローが繋がっている必要があります

### トランザクションが失敗する

- ガス残高が十分にあるか確認してください
- 分割元の SUI コイン（gas）の残高が、送金額合計 + ガス代を上回っているか確認してください
- 残高が不足している場合は、[Faucet](/docs/getting-started/L06-get-test-tokens) で追加のSUIを取得してください

---

## 演習: TypeScriptコードで実装してみよう

PTB Builderには、作成したPTBをTypeScriptコードとしてエクスポートする機能があります。

1. 画面右上の「**Export**」ボタンをクリックします
2. 表示されたTypeScriptコードを確認します

TypeScriptで同じことを実装すると、以下のようになります：

```typescript
import { Transaction } from '@mysten/sui/transactions';

const tx = new Transaction();

// 1つ目の送金
const [coin1] = tx.splitCoins(tx.gas, [1_000_000_000]); // 1 SUI
tx.transferObjects([coin1], recipientAddress1);

// 2つ目の送金
const [coin2] = tx.splitCoins(tx.gas, [2_000_000_000]); // 2 SUI
tx.transferObjects([coin2], recipientAddress2);

// トランザクションを実行
const result = await signAndExecuteTransaction({ transaction: tx });
```

このコードは、次のレッスンで詳しく解説します。今は「GUIで作ったものがコードになるんだ」ということを確認できればOKです。

:::tip
エクスポートされるコードは、CLIやSDKで書くPTBと本質的に同じ構造です。
:::

---

## このレッスンでやったこと

- [x] PTB（Programmable Transaction Block）の概念を理解した
- [x] サイト内のPTB Builderで2つの送金操作を確認した
- [x] 1つのトランザクションにまとめて実行した
- [x] Explorerで結果を確認した
- [x] TypeScriptコードへのエクスポート機能を確認した
