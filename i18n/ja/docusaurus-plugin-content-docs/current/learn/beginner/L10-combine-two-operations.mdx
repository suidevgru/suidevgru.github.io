---
sidebar_position: 10
title: "2操作を合成"
description: "複数操作を1つのトランザクションにまとめる"
---

import BrowserOnly from '@docusaurus/BrowserOnly';
import { PtbBuilderDemo } from '@site/src/components/PtbBuilderDemo';

# 2操作を合成

このレッスンでは、PTB Builderを使って**2つの送金操作を1つのトランザクションにまとめるPTBを、ゼロから自分で組み立て**ます。**難しくありません**。手順どおりに進めれば完成します。

## PTB（Programmable Transaction Block）とは

Suiでは、複数の操作を**1つのトランザクション**にまとめて実行できます。これを **PTB（Programmable Transaction Block）** と呼びます。

PTBを使うと、以下のようなメリットがあります：

- **ガス代の節約（主にオーバーヘッド）** — 複数トランザクションに分けるより、署名や基本コストを1回にまとめられます
- **原子性（アトミック性）** — すべての操作が成功するか、すべて失敗するかのどちらかになります（中途半端な状態になりません）
- **効率的** — 1回の署名で複数の操作を完了できます

:::tip PTBのイメージ
「Aさんに1 SUI送金」と「Bさんに2 SUI送金」を別々に実行すると、2回署名が必要で、ガス代も2回かかります。
PTBでまとめると、1回の署名・1回のガス代で済みます。
:::

---

## 前提条件

このレッスンを始める前に、以下が完了していることを確認してください：

- [Slushウォレットをインストール](/docs/getting-started/L01-install-slush) 済み
- [Devnetに切り替え](/docs/getting-started/L02-switch-devnet) 済み
- [Faucetでテストトークンを取得](/docs/getting-started/L06-get-test-tokens) 済み

---

## PTB Builder で2つの送金を組み立てよう

以下のビジュアルエディタは**空の状態**です。`Start` と `End` のノードだけがあります。

左上の**ガイド**に従ってノードを追加・接続し、2つの送金操作を1つのトランザクションに組み立ててください。
まず、サイトヘッダー右上のウォレットアイコンから**Slushウォレットを接続**してください。

<BrowserOnly>
  {() => <PtbBuilderDemo answerTemplateId="double-transfer" tutorialId="double-transfer" />}
</BrowserOnly>

---

## Explorerで確認

トランザクション実行後、Explorerで結果を確認しましょう：

1. 表示された Transaction Digest の横のリンクをクリックします
2. Suiscan（または別のExplorer）が開きます
3. **Transactions** セクションで、2つの TransferObjects 操作が含まれていることを確認します

---

## 演習: TypeScriptコードで実装してみよう

PTB Builderには、作成したPTBをTypeScriptコードとしてエクスポートする機能があります。

1. ビルダー右下の「**Export**」ボタン（↓アイコン）をクリックします
2. `.ptb` ファイルとしてダウンロードされます

TypeScriptで同じことを実装すると、以下のようになります：

```typescript
import { Transaction } from '@mysten/sui/transactions';

const tx = new Transaction();

// 1つ目の送金
const [coin1] = tx.splitCoins(tx.gas, [1_000_000_000]); // 1 SUI
tx.transferObjects([coin1], recipientAddress1);

// 2つ目の送金
const [coin2] = tx.splitCoins(tx.gas, [2_000_000_000]); // 2 SUI
tx.transferObjects([coin2], recipientAddress2);

// トランザクションを実行
const result = await signAndExecuteTransaction({ transaction: tx });
```

このコードは、次のレッスンで詳しく解説します。今は「GUIで作ったものがコードになるんだ」ということを確認できればOKです。

:::tip
エクスポートされるコードは、CLIやSDKで書くPTBと本質的に同じ構造です。
:::

---

## 成功の確認

以下ができれば、このレッスンは完了です：

- [ ] 空のPTB Builderにノードを追加して、2つの送金PTBを組み立てられた
- [ ] gas ノードを2つの SplitCoins に接続できた
- [ ] 1つのトランザクションとして実行できた
- [ ] Explorerで2つの送金操作が含まれていることを確認できた

---

## よくあるトラブル

### ウォレットが接続できない

- ブラウザ拡張機能のSlushウォレットがインストールされているか確認してください
- ネットワークがDevnetに設定されているか確認してください
- [L07: ウォレットをPTB Builderに接続する](/docs/learn/beginner/L07-connect-wallet-to-ptb-builder) を参照してください

### Execute ボタンが押せない

- ウォレットが接続されているか確認してください
- すべてのノードが正しく接続されているか確認してください
- Start から End まで途切れなくフローが繋がっている必要があります

### トランザクションが失敗する

- ガス残高が十分にあるか確認してください
- 分割元の SUI コイン（gas）の残高が、送金額合計 + ガス代を上回っているか確認してください
- 残高が不足している場合は、[Faucet](/docs/getting-started/L06-get-test-tokens) で追加のSUIを取得してください

---

## このレッスンでやったこと

- [x] PTB（Programmable Transaction Block）の概念を理解した
- [x] 空のPTB Builderからノードを追加・接続して、2つの送金PTBを組み立てた
- [x] 1つのトランザクションにまとめて実行した
- [x] Explorerで結果を確認した
- [x] TypeScriptコードへのエクスポート機能を確認した
